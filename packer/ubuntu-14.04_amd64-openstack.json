{
  "variables": {
    "openstack_username": "{{env `OPENSTACK_USERNAME`}}",
    "openstack_api_key": "{{env `OPENSTACK_API_KEY`}}",
    "openstack_password": "{{env `OPENSTACK_PASSWORD`}}",
    "openstack_provider_region": "{{env `OPENSTACK_PROVIDER_REGION`}}",
    "openstack_provider": "{{env `OPENSTACK_PROVIDER`}}",
    "mesos_version": "0.22.1-1.0.ubuntu1404",
    "marathon_version": "0.8.2-1.0.306.ubuntu1404",
    "consul_version": "0.5.2",
    "weave_version": "1.0.1",
    "version": "{{env `APOLLO_VERSION`}}",
    "openstack_region": "{{env `OPENSTACK_REGION`}}",
    "openstack_flavour": "{{env `OPENSTACK_FLAVOUR`}}",
    "openstack_source_image": "{{env `OPENSTACK_SOURCE_IMAGE`}}"
  },
  "builders": [{
    "type": "openstack",
    "username": "{{user `openstack_username`}}",
    "password": "{{user `openstack_password`}}",
    "api_key": "{{user `openstack_api_key`}}",
    "openstack_provider": "rackspace",
    "provider": "{{user `openstack_provider_region`}}",
    "region": "{{user `openstack_region`}}",
    "flavor": "{{user `openstack_flavour`}}",
    "image_name": "apollo-ubuntu-14.04-amd64 {{timestamp}}",
    "source_image": "{{user `openstack_source_image`}}",
    "ssh_username": "root",
    "ssh_timeout": "10m"
  }],
  "provisioners": [
    {
      "type": "file",
      "source": "scripts/ubuntu/upstart/",
      "destination": "/tmp"
    },
    {
      "type": "shell",
      "environment_vars": [
        "CONSUL_VERSION={{user `consul_version`}}",
        "WEAVE_VERSION={{user `weave_version`}}",
        "MESOS_VERSION={{user `mesos_version`}}",
        "MARATHON_VERSION={{user `marathon_version`}}"
      ],
      "scripts": [
        "scripts/ubuntu/base.sh",
        "scripts/common/sshd.sh",
        "scripts/ubuntu/install_docker.sh",
        "scripts/ubuntu/install_mesos.sh",
        "scripts/ubuntu/install_marathon.sh",
        "scripts/common/install_consul.sh",
        "scripts/ubuntu/install_dnsmasq.sh",
        "scripts/common/install_weave.sh"
      ],
      "execute_command": "{{ .Vars }} sudo  -E -S bash -c '{{ .Path }}'"
    },
    {
      "type": "file",
      "source": "tests",
      "destination": "/tmp"
    },
    {
      "type": "shell",
      "script": "scripts/common/serverspec.sh",
      "execute_command": "{{ .Vars }} sudo  -E -S bash -c '{{ .Path }}'"
    }
  ],
  "push": {
    "name": "capgemini/apollo"
  },
  "post-processors": [{
    "type": "atlas",
    "artifact": "capgemini/apollo-ubuntu-14.04-amd64",
    "artifact_type": "openstack.image",
    "metadata": {
      "created_at": "{{timestamp}}",
      "version": "{{user `version`}}+{{timestamp}}"
    }
  }]
}
